name: solr

project_files:
- commands/solr/
- commands/host/solr-admin
- docker-compose.solr.yaml
- solr/

pre_install_actions:
  - |
    #ddev-description:Removing old Dockerfile
    file="${DDEV_APPROOT}/.ddev/solr/Dockerfile"
    if [ -f "${file}" ]; then
      if grep -q '#ddev-generated' "${file}"; then
        rm -f "${file}"
      else
        echo "${file} needs to be removed but has been modified by the user. Please check it and remove it"
        exit 2
      fi
    fi

ddev_version_constraint: '>= v1.24.3'

post_install_actions:
  - |
    #ddev-description:Configuring authentication
    solr_auth_type="$(ddev dotenv get .ddev/.env.solr --solr-auth-type 2>/dev/null || true)"
    solr_authentication_opts="$(ddev dotenv get .ddev/.env.solr --solr-authentication-opts 2>/dev/null || true)"
    if [ "${solr_auth_type}" = "" ]; then
      if grep -q '#ddev-generated' solr/security.json; then
        printf "{\n  \"#ddev-generated\":true\n}\n" >solr/security.json
      fi
      if [ "${solr_authentication_opts}" != "" ]; then
        ddev dotenv set .ddev/.env.solr --solr-authentication-opts=""
      fi
    elif [ "${solr_auth_type}" = "basic" ]; then
      ddev dotenv set .ddev/.env.solr --solr-auth-type="basic" --solr-authentication-opts="-Dbasicauth=solr:SolrRocks"
    fi
